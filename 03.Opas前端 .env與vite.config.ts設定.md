# Opas 前端 .env 、 vue-router 與 vite.config.ts 設定

> 說明，`.env` 與 `vite.config.ts` 的設定與用法。

---

## 1. .env 設定

`.env` 檔案用於設定環境變數，可以被 `vite.config.ts` 讀取。

```bash
# .env
VITE_PROJECT = 'APQP'       ## 專案名稱
VITE_MVC_PORT = '51198'     ## ASP.NET MVC 5 Port
```

> 註：`.env` 檔案中的變數名稱必須以 `VITE_` 為開頭，才能在前端代碼中使用。

由於Opas後端是以多專案的形式開發，而本專案是為了統合多專案的前端而生，因此開發前端時，需要透過設定.env的變數來切換不同的後端專案，以取得正確的資料。

## 2. vite.config.ts 設定

`vite.config.ts` 檔案用於設定 Vite 開發伺服器，可以讀取 `.env` 檔案中的環境變數。


```ts
import { defineConfig, loadEnv } from 'vite';
import vue from '@vitejs/plugin-vue';
import fs from 'fs';
import path from 'path';
import * as prettier from 'prettier';
import { quasar, transformAssetUrls } from '@quasar/vite-plugin';
import fse from 'fs-extra';

interface Route {
  path: string;
  component: string;
  children?: { path: string; component: string }[];
}

export default ({ mode }: { mode: string }) => {
  console.log(`Building in mode: ${mode}`);

  // 讀取 .env 檔案中的環境變數
  Object.assign(process.env, loadEnv(mode, process.cwd()));

  // (後端) 開發模式下的靜態資源目錄
  const localFolder = `dist/${process.env.VITE_PROJECT}/scripts/dist/assets.local`;

  // (線上版本) 部署模式下的靜態資源目錄
  const remoteFolder = `dist/${process.env.VITE_PROJECT}/scripts/dist/assets`;
  // 打包後，按照VITE_PROJECT的值，將打包後的檔案放到指定的資料夾下
  const destinationFolder = `dist/${process.env.VITE_PROJECT}`;

  return defineConfig({
    plugins: [
      vue({
        template: {
          transformAssetUrls,
        },
      }),
      quasar({}),
      // 生成路由檔案，每次啟動專案時，都會重新生成一次
      {
        name: 'generate-routes',
        enforce: 'pre',
        buildStart() {
          const routesMap = JSON.parse(
            fs.readFileSync('./src/routes/map.json', 'utf-8').trim(),
          ) as Record<string, Route[]>;

          const projectName = process.env.VITE_PROJECT as string;
          const virtualPath = mode === 'development' ? '' : `/${projectName}`;

          const routeCode = `
            import { createRouter, createWebHistory } from 'vue-router';

            const routes = [
              ${routesMap[projectName]
                .map((r: Route) => {
                  if (Object.hasOwn(r, 'children')) {
                    return `{ path: '${virtualPath}${r.path}', component: () => import('${r.component}'), children: [${r.children
                      .map(
                        (c) =>
                          `{ path: '${c.path}', component: () => import('${c.component}') }`,
                      )
                      .join(',\n')}] }`;
                  }
                  return `{ path: '${virtualPath}${r.path}', component: () => import('${r.component}') }`;
                })
                .join(',\n')}
            ];

            export default createRouter({
              history: createWebHistory(),
              routes,
            });
          `;

          (async () => {
            const formattedCode = await prettier.format(routeCode, {
              parser: 'babel',
              singleQuote: true,
              trailingComma: 'all',
            });

            fs.writeFileSync(
              path.resolve(__dirname, './src/routes/index.ts'),
              formattedCode,
            );
            console.log('✅ Routes file generated!');
          })();
        },
      },
      // 打包後，按照VITE_PROJECT的值，將打包後的檔案放到指定的資料夾下
      {
        name: 'move-files-after-build',
        async closeBundle() {
          try {
            if (mode === 'production') {
              await moveFiles(destinationFolder, remoteFolder);
            }

            if (mode === 'development') {
              await moveLocalFiles(destinationFolder, localFolder);
            }

            // await moveToDestination();
          } catch (_err) {}
        },
      },
    ],
    resolve: {
      alias: [{ find: '@', replacement: '/src' }],
    },
    build: {
      minify: true,
      emptyOutDir: false,
      rollupOptions: {
        input: './src/main.ts',
        output: {
          dir: 'dist',
          manualChunks: (id) => {
            if (id.includes('node_modules')) {
              if (id.includes('echarts')) return 'echarts';
              if (id.includes('zrender')) return 'zrender';
              return 'others';
            }
          },
          // 分成開發模式與部署模式的檔案名稱，與後端讀取JS、CSS等靜態資源時的路徑一致
          assetFileNames: (assetInfo) => {
            if (mode === 'development') {
              return 'scripts/dist/assets.local/[name].[ext]';
            }

            if (assetInfo.name?.endsWith('.css')) {
              return `${process.env.VITE_PROJECT}/scripts/dist/assets/[name]-${timestamp}.[ext]`;
            }

            return `${process.env.VITE_PROJECT}/scripts/dist/assets/[name].[ext]`;
          },
          entryFileNames: () => {
            if (mode === 'development') {
              return 'scripts/dist/assets.local/[name].js';
            }

            return `${process.env.VITE_PROJECT}/scripts/dist/assets/[name]-${timestamp}.js`;
          },
          chunkFileNames: (assetInfo: { name: string }) => {
            const filename = assetInfo.name.endsWith('.vue_vue_type_script_setup_true_lang')
              ? assetInfo.name.split('.')[0]
              : assetInfo.name;

            if (mode === 'development') {
              return `scripts/dist/assets.local/${filename}.js`;
            }

            if (
              assetInfo.name.startsWith('echarts') ||
              assetInfo.name.startsWith('zrender')
            ) {
              return `${process.env.VITE_PROJECT}/scripts/dist/assets/[name]-${timestamp}.js`;
            }

            return `${process.env.VITE_PROJECT}/scripts/dist/assets/${filename}-${timestamp}.js`;
          },
        },
      },
    },
  });
};
```

## 3. vue-router 設定

`vue-router` 用於設定路由，可以讀取 `.env` 檔案中的環境變數，根據VITE_PROJECT，讀取./src/routes/map.json中的路由設定。

```ts
// src/routes/index.ts
import { createRouter, createWebHistory } from 'vue-router';

const routes = [
  // ...
  {
    path: `/Default/FocusCustomer`,
    component: () => import('../pages/TestPPI/FocusCustomer.vue'),
  },
];

export default createRouter({
  history: createWebHistory(),
  routes,
});
```